<!DOCTYPE HTML>
<html>
<head>
	<style>
	html, body { 
   		 margin:0; 
   		 padding:0; 
   		 height:100%; 
	}
	body {
		background:black;
		color:white;
	}
	#ulSongList { 
		padding:3px; 
		margin:0;
		height:100%;
		float:left;
	}
	#ulSongList > li {
		margin:2px;
		padding:1px;
		list-style: none;
		border-radius:5px;
		
		border: solid 1px white;
	}
	</style>
	<script type="text/javascript" src="https://www.youtube.com/iframe_api"></script>
	<script src="script/framework.js"></script>
</head>
<body>
<ul id="ulSongList"></ul>
<div id="port"></div>
<p id="status">Now playing: Bios - Guilty Crown</p>

<script type="text/javascript">
	function onYouTubeIframeAPIReady(){ init(); } //Necessary because youtube is pretty specific about making the api call this particularly named function.

	var view = {
		songList: document.querySelector("#ulSongList"),
		player : document.querySelector("#port"),
		status: document.querySelector("#status"),
		setStatus(state,message){
			this.status.innerText = `${state}: ${message}`;
		},
	};

	function Song(title,id){
		if(!(this instanceof Song)){ throw new Error("song is a constructor and must be called with the new keyword.")}
		this.title = title;
		this.id = id;
	}

	//Feels kinda dirty making this global but this needs to be referenced in various different scopes
	var songList = [	new Song("Bios - Guilty Crown","UMCka_vXtL4"),
						new Song("Unravel - Tokyo Ghoul","QKXi08chD2E"),
						new Song("God Knows... - The Melancholy of Haruhi Suzumiya","WWB01IuMvzA"),
						new Song("Let Me Hear - Parasyte","yWlUCpXyh9w"),
						new Song("Silent Solitude - OxT","_4IlQEK1Vug"),
						new Song("Voracity - MYTH & ROID","D-LXfVLL5Tc"),
						new Song("Blue Exorcist OP 2","H5wtqQPEpt8"),
						new Song("Psycho Pass OP 3","fmKPfgsclHg"),
	];

	function init(){	
		setupView();

		//Constructor prevents me from setting events from view model. Initial video id needs to be loaded here because for some reason it doesnt finish initializing for a short bit.
		viewModel.setPlayer(
			new YT.Player('port',{
				height : "300",
				width  : "300",
				videoId : songList[0].id,
				events : {
					onReady : viewModel.playerEvents.ready,
					onStateChange : viewModel.playerEvents.stateChanged,
				},
			})
		);
	}

	function setupView(){
		songList.forEach(song=>{
			var el = document.createElement("li");
			el.innerHTML = song.title;
			el.dataset.id = song.id;
			el.onclick = viewModel.events.videoSelected;

			view.songList.appendChild(el);
		});
	}

	var viewModel = (function(){
		var _model = new Observable({
			songID : null,
			currentSong : null,
		});
		var _player;

		var playerEvents = {
			ready(){},
			stateChanged(){ },//Don't autoplay. Not 100% sure how to implement yet
		};

		_model.subscribe("change/songID",function(id){ loadVideo(id.new); _model.currentSong = songList.find(song => song.id == id.new);  });
		_model.subscribe("change/currentSong", function(song){ view.setStatus("Now Playing", song.new.title); });

		function loadVideo(id){ _player.loadVideoById({videoId:id}); }

		var _ = {
			setPlayer(ytPlayer){
				_player = ytPlayer;
			},
			getPlayer(){ return _player; },
			events : {
				videoSelected(){
					_model.songID = this.dataset.id;
				},
			},
			playerEvents: playerEvents,
		};
		return _;
	})();
</script>
</body>
</html>