<!DOCTYPE HTML>
<html>
<head>
	<title>D - Simple Youtube</title>
	<style>
	html, body { 
   		 margin:0; 
   		 padding:0; 
   		 height:100%; 
	}
	body {
		background:black;
		color:white;
	}
	.containerLeft {
		width:12.5%;
		height:100%;
		float:left;
	}
	.containerRight {
		width:87.5%;
		height:100%;
	}
	#ulSongList { 
		padding:3px; 
		margin:0;
		height:100%;
		width:100%;
		overflow-y: scroll;
	}
	#ulSongList > li {
		margin:2px;
		padding:1px;
		list-style: none;
		border-radius:5px;
		cursor:pointer;
		border: solid 1px white;
		overflow:hidden;
		text-overflow: ellipsis;
		white-space: nowrap;
		-webkit-transition: all 0.4s ease-in;
    	-moz-transition: all 0.4s ease-in;
    	-o-transition: all 0.4s ease-in;
    	transition: all 0.4s ease-in;
	}
	.player-control {
		cursor: pointer;
	}

	.isNotVisible {
		visibility: hidden;
	}
	.activated {
		background-color:white;
		color:black;
	}
	</style>
	<script type="text/javascript" src="https://www.youtube.com/iframe_api"></script>
	<script src="script/framework.js"></script>
</head>
<body>
	<div class="containerLeft">
		<ul id="ulSongList"></ul>
	</div>
	<div class="containerRight">
		<div>
			<div id="port"></div>
			<p>
				<span class="player-control" data-prop="prev" style="color:red"><-</span>
				<span class="player-control" data-prop="togglePlay" style="color:yellow">-</span>
				<span class="player-control" data-prop="next" style="color:green">-></span>
				<span><label>Hide:<input data-prop="displayPort" type="checkbox" /></label></span>
			</p>
			<p id="status">Now playing: Bios - Guilty Crown</p>
		</div>
	</div>
<script type="text/javascript">
	function onYouTubeIframeAPIReady(){ init(); } //Necessary because youtube is pretty specific about making the api call this particularly named function.

	var view = {
		songList: document.querySelector("#ulSongList"),
		player : document.querySelector("#port"),
		status: document.querySelector("#status"),
		displayPort : document.querySelector("[data-prop='displayPort']"),
		setStatus(state,message){
			this.status.innerText = `${state}: ${message}`;
		},
	};

	function Song(title,id){
		if(!(this instanceof Song)){ throw new Error("song is a constructor and must be called with the new keyword.")}
		this.title = title;
		this.id = id;
	}

	//Feels kinda dirty making this global but this needs to be referenced in various different scopes
	var songList = [	new Song("Unravel - Tokyo Ghoul","QKXi08chD2E"),
						new Song("God Knows... - The Melancholy of Haruhi Suzumiya","WWB01IuMvzA"),
						new Song("Let Me Hear - Parasyte","yWlUCpXyh9w"),
						new Song("Silent Solitude - OxT","_4IlQEK1Vug"),
						new Song("Voracity - MYTH & ROID","D-LXfVLL5Tc"),
						new Song("Blue Exorcist OP 2","H5wtqQPEpt8"),
						new Song("Enigmatic Feeling - Ling Tosite Sigure","fmKPfgsclHg"),
						new Song("Abnormalize - Ling Tosite Sigure","J6Ja3Vip1tg"),
						new Song("We Will Rock You - Monster Strike","l8YXfBP3VFM"),
						new Song("Daze - Mekakucity Actors","jgv-IFmIn8c"),
						new Song("Pantomime - IA","JAXukKb0fgU"),
						new Song("Soul Eater OP 1","UAzpX8-P4WE"),
						new Song("Silly-Go-Round - FictionJunction","GzGWvvYOqK4"),
						new Song("Mob Psycho OP","l5rPZJiYFfg"),
						new Song("Fallen - EGOIST", "0lSLpbAxBTA"),
						new Song("Genesis - Stereo Dive Foundation", "hMKDN6B6fQA"),
						
	];

	function init(){	
		setupView();

		//Constructor prevents me from setting events from view model. Initial video id needs to be loaded here because for some reason it doesnt finish initializing for a short bit.
		viewModel.setPlayer(
			new YT.Player('port',{
				height : "450",
				width  : "800",
				videoId : songList[0].id,
				events : {
					onReady : viewModel.playerEvents.ready,
					onStateChange : viewModel.playerEvents.stateChanged,
				},
			})
		);
	}

	function setupView(){
		songList.forEach(song=>{
			var el = document.createElement("li");
			el.innerHTML = song.title;
			el.title = song.title;
			el.dataset.id = song.id;
			el.onclick = viewModel.events.videoSelected;

			view.songList.appendChild(el);
		});
		view.port = document.getElementById("port");
	}

	var viewModel = (function(){
		var _model = new Observable({
			idx : -1,
			songID : null,
			currentSong : null,
		});
		var autoplay = true;

		var _player;
		var _playerState = {
			UNSTARTED : -1,
			ENDED : 0,
			PLAYING : 1,
			PAUSED : 2,
			BUFFERING : 3,
			CUED : 5,
		};

		document.querySelector("[data-prop='prev']").onclick = prevSong;
		document.querySelector("[data-prop='next']").onclick = nextSong;
		view.displayPort.onclick = function(){ 
			var isDisplayed = this.checked,
			    port = document.getElementById("port"); //Would rather not do this but binding timings are weird so sometimes it still references the original div
			if(isDisplayed){
				port.classList.add("isNotVisible");
			} else {
				port.classList.remove("isNotVisible");
			}
		 }

		function nextSong(){
			if(_model.idx == songList.length -1){
				_model.idx = 0;
			} else if(_model.idx <= songList.length -2){
				_model.idx++;
			}
		}
		function prevSong(){
			if(_model.idx == 0){
				_model.idx = songList.length -1;
			} else {
				_model.idx--;
			}
		}

		function toggleClass(domElement,className){
			if(domElement.classList.contains(className)){
				domElement.classList.remove(className);
			} else {
				domElement.classList.add(className);
			}
		}

		var playerEvents = {
			ready(){},
			stateChanged(eventData){ 
				//Wish they would rename this to PLAYER_STATE or something because that's what it really is
				if(eventData.data == _playerState.ENDED){
					if(_model.idx > -1 && autoplay){
						nextSong();
					}
				}
			 },
		};

		_model.subscribe("change/idx", function(idx){ _model.songID = songList[idx.new].id; });
		_model.subscribe("change/songID",function(id){ 
			loadVideo(id.new); 
			_model.currentSong = songList.find(song => song.id == id.new); 
			_model.idx = songList.map(x=> x.id).indexOf(id.new);
	    });
		_model.subscribe("change/currentSong", function(song){ 
			view.setStatus("Now Playing", song.new.title); 

			var currentSongLi = document.querySelector("#ulSongList li.activated");
			if(currentSongLi != null){
				currentSongLi.classList.remove("activated");
			}		
			document.querySelector(`#ulSongList li[data-id="${_model.songID}"]`).classList.add("activated");
		});

		function loadVideo(id){ _player.loadVideoById({videoId:id}); }

		var _ = {
			setPlayer(ytPlayer){
				_player = ytPlayer;
			},
			getPlayer(){ return _player; },
			events : {
				videoSelected(){
					_model.songID = this.dataset.id;
				},
			},
			playerEvents: playerEvents,
		};
		return _;
	})();
</script>
</body>
</html>